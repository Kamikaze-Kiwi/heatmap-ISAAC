<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/maps/modules/map.js"></script>
<script src="http://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://rawgithub.com/paulo-raca/highcharts-contour/master/highcharts-contour.js"></script>
<script src="https://rawgithub.com/ironwallaby/delaunay/master/delaunay.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
  .hidden {
    visibility: hidden
  }
</style>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>



<div id="container" style="height: 80%;
  width: 80%; margin: 0 auto"></div>
<div class="container">
  <label for="slider" class="form-label">Datum -&nbsp; 
    <input onchange="getDataByDay(this.valueAsDate)"  type="date" id="dateNow" name="trip-start">
    &nbsp;&nbsp;Tijd&nbsp;-&nbsp;
    <input id="nogniet" type="time" step="1" />
    <span
      id="SelectValue">
    </span>
  </label>
  <input class="form-range" oninput="setTimeLimit(), updateHeatmapByTime(this.value / 30)" type="range" min="0" max="86400" value="" step="30" id="slider">

  <div id="error" class=" hidden alert alert-primary d-flex align-items-center" role="alert">
    <i class="bi bi-info-circle-fill"></i>
    <div>
      &nbsp;<span id="errormsg"></span>
    </div>
  </div>
</div>

<input style="display: none;" class="form-range" oninput="console.log('weird'), setTimeLimit(), updateHeatmapByTime(this.value / 30)"
  type="range" min="0" max="86400" value="" step="30" id="slider">



<!-- date picker code for today -->
<script>
  var todayDate = new Date().toISOString().slice(0, 10);
  document.getElementById('dateNow').value = todayDate;
  document.getElementById('dateNow').max = todayDate;
</script>

<!-- show time and convert seconds to HH:MM:SS format -->
<script>
  var SelectValue = document.getElementById("SelectValue");

  SelectValue.innerHTML = slider.value;

  function convertHMS(value) {
    const sec = parseInt(value, 10); // convert value to number if it's string
    let hours = Math.floor(sec / 3600); // get hours
    let minutes = Math.floor((sec - (hours * 3600)) / 60); // get minutes
    let seconds = sec - (hours * 3600) - (minutes * 60); //  get seconds
    if (seconds < 30) {
      seconds = 0;
    }
    else {
      seconds = 30;
    }
    // add 0 if value < 10; Example: 2 => 02
    if (hours < 10) { hours = "0" + hours; }
    if (minutes < 10) { minutes = "0" + minutes; }
    if (seconds < 10) { seconds = "0" + seconds; }
    return hours + ':' + minutes + ':' + seconds; // Return is HH : MM : SS
  }


  // get time NOW and convert to seconds
  var d = new Date(); // for now
  datetext = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();


  var hms = datetext;   // your input string
  var a = hms.split(':'); // split it at the colons

  // minutes are worth 60 seconds. Hours are worth 60 minutes.
  var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);


  document.getElementById('SelectValue').innerHTML = convertHMS(seconds);


  slider.oninput = function () {
    SelectValue.innerHTML = convertHMS(this.value);
  }

  //set limit according to time NOW
  function setTimeLimit() {
    var checkDate = new Date().toISOString().slice(0, 10);
    if (document.getElementById("slider").value > seconds && document.getElementById("dateNow").value == checkDate) {
      console.log("success");
      document.getElementById("slider").value = seconds
      SelectValue.innerHTML = convertHMS(seconds);
      document.getElementById("error").style.visibility = "visible";
      document.getElementById("errormsg").innerHTML = "de tijd kan niet in de toekomst liggen!";
    }
    else {
      document.getElementById("error").style.visibility = "hidden";
    }
  }

</script>

<script>
  var chart = Highcharts.chart('container', {
    data: {
      rows: [['x', 'y', 'Temperature'],
      [0, 0, 0]]
    },
    chart: {
      type: 'contour',
      inverted: false,
      plotBackgroundImage: 'derde-verdieping.svg'
    },
    title: {
      text: null
    },
    accessibility: {
      point: {
        descriptionFormatter: function (point) {

        }
      }
    },
    tooltip: {
      formatter: function () {
        return this.point.value + ' Â°C';
      }
    },
    yAxis: {
      minPadding: 0,
      maxPadding: 0,
      startOnTick: false,
      endOnTick: false,
      visible: false,
      reversed: true,
      labels: {
        enabled: false
      },
      title: {
        text: null
      },
    },
    xAxis: {
      minPadding: 0,
      maxPadding: 0,

      startOnTick: false,
      endOnTick: false,
      tickLength: 0,
      labels: {
        enabled: false
      }
    },
    colorAxis: {
      stops: [
        [0.00, 'rgba(0,0,250,0.5)'],
        [0.24, 'rgba(0,250,250,0.5)'],
        [0.33, 'rgba(0,250,0,0.5)'],
        [0.50, 'rgba(250,250,0,0.5)'],
        [0.80, 'rgba(250,0,0,0.5)']
      ],
      min: 10,
      max: 40
    },
    series: [{
      borderWidth: 0
    }]
  });
</script>

<script>
  let selectedDayData = [];

  let dateTimeText = document.getElementById('selectedDateTime');

  getDataByDay(new Date());

  function getDataByDay(datetime) {
    let config = {
      params: {
        StartDate: datetime.toISOString()
      }
    }

    axios.get(
      'https://i464318core.venus.fhict.nl/api/temperatures/History', config
    ).then(function (response){
      selectedDayData = response.data
      updateHeatmapByTime(document.getElementById('slider').value / 30);
    })
  }



  function updateHeatmapByTime(index) {
    let currentData = selectedDayData[index];

    let parsedData = [['x', 'y', 'Temperature']];
    currentData.forEach(sensor => {
      parsedData.push([sensor.x, sensor.y, sensor.value])
    });

    console.log(parsedData);

    chart.series[0].update({
      data: parsedData
    })
  }

</script>